<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Albero Abilità | Cripta di Sangue</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link rel="stylesheet" href="../assets/css/abyssal.css">

        <style>
        /* STILI AGGIUNTIVI SPECIFICI PER L'ALBERO */
        
        /* Layout Principale a due colonne */
        .skill-layout {
            display: flex;
            gap: 2rem;
            align-items: flex-start;
            justify-content: center;
            max-width: 1400px; 
            margin: 0 auto;
        }

        .tree-column {
            flex: 1; /* Prende lo spazio disponibile */
            min-width: 0; /* Fix per flexbox overflow */
        }

        .info-column {
            width: 450px; 
            flex-shrink: 0;
            position: sticky;
            top: 2rem; /* Rimane visibile mentre scrolli se la pagina è lunga */
        }

        /* Navigazione Tab */
        .skill-nav {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .skill-tab {
            background: rgba(0,0,0,0.6);
            border: 1px solid var(--gold-dim, #8a7329);
            color: var(--text-muted, #a0a0a0);
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            transition: all 0.3s ease;
            border-radius: 4px;
            min-width: 120px;
            text-align: center;
        }

        .skill-tab:hover, .skill-tab.active {
            background: var(--gold-dim, #8a7329);
            color: #fff;
            border-color: var(--gold, #d4af37);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
            transform: translateY(-2px);
        }

        /* Contenitore Albero */
        .tree-wrapper {
            position: relative;
            width: 100%;
            /* Aspect ratio verticale */
            aspect-ratio: 4 / 5;
            min-height: 600px;

            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 12px;
            background-color: rgba(0,0,0,0.5); 
            border: 2px solid rgba(138, 28, 28, 0.3);
            box-shadow: inset 0 0 80px #000;
            overflow: hidden; 
        }

        /* SVG per le linee */
        .tree-connections {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        .connection-line {
            stroke: #444;
            stroke-width: 4; /* Linee più spesse */
            transition: stroke 0.3s ease;
        }

        .connection-line.unlocked {
            stroke: #d4af37;
            filter: drop-shadow(0 0 4px #d4af37);
            stroke-width: 5;
        }

        .connection-line.unlockable {
            stroke: #595442;
            filter: drop-shadow(0 0 4px #d4af37);
            stroke-width: 5;
        }

        /* Nodi */
        .skill-node {
            position: absolute;
            width: 65px;
            height: 65px;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            border: 3px solid #333;
            background-color: #000;
            background-size: cover;
            background-position: center;
            z-index: 2;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 10px rgba(0,0,0,0.8);
        }

        /* STATO: BLOCCATO */
        .skill-node.locked {
            filter: grayscale(100%) brightness(0.4);
        }

        /* STATO: SBLOCCATO (Acquisito) */
        .skill-node.unlocked {
            border-color: #d4af37;
            filter: grayscale(0%);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
        }

        /* STATO: SBLOCCABILE (Disponibile) */
        .skill-node.unlockable {
            border-color: #9c8a51;
            filter: grayscale(50%); /* Ancora grigio ma meno scuro */
            animation: pulse-unlockable 2s infinite;
        }

        @keyframes pulse-unlockable {
            0% { box-shadow: 0 0 0 rgba(212, 175, 55, 0); border-color: #666; }
            50% { box-shadow: 0 0 15px rgba(212, 175, 55, 0.5); border-color: #d4af37; transform: translate(-50%, -50%) scale(1.05); }
            100% { box-shadow: 0 0 0 rgba(212, 175, 55, 0); border-color: #666; }
        }

        .skill-node.key-node {
            width: 85px;
            height: 85px;
            border-width: 4px;
            border-color: #d4af37;
            box-shadow: 0 0 25px rgba(212, 175, 55, 0.6);
            z-index: 3;
        }

        .skill-node:hover, .skill-node.selected {
            transform: translate(-50%, -50%) scale(1.15);
            z-index: 10;
            border-color: #fff;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            filter: grayscale(0%); /* Mostra colore al passaggio mouse anche se bloccato */
        }

        /* PANNELLO INFO LATERALE (Il Grimorio) */
        .info-card {
            background: rgba(18, 18, 18, 0.95);
            border: 1px solid #8a1c1c;
            border-radius: 8px;
            padding: 2rem;
            min-height: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            position: relative;
            overflow: hidden;
        }

        /* Elemento decorativo di sfondo */
        .info-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 5px;
            background: linear-gradient(90deg, transparent, #8a1c1c, transparent);
        }

        .info-header {
            text-align: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 1rem;
        }

        .info-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #d4af37;
            margin: 0 auto 1rem auto;
            display: block;
            object-fit: cover;
            background-color: #000;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
        }

        .info-title {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            color: #d4af37;
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }

        .info-flavor {
            font-family: 'Crimson Text', serif;
            font-style: italic;
            color: #a0a0a0;
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
        }

        .info-desc {
            font-family: 'Montserrat', sans-serif;
            color: #e0e0e0;
            font-size: 0.95rem;
            line-height: 1.7;
            text-align: left;
        }
        
        .info-desc p {
            margin-bottom: 1rem;
        }
        
        .info-desc ul {
            list-style-type: none;
            padding-left: 0;
            margin-bottom: 1rem;
        }
        
        .info-desc li {
            margin-bottom: 0.5rem;
            padding-left: 1.5rem;
            position: relative;
        }
        
        .info-desc li::before {
            content: '♦';
            color: #d4af37;
            position: absolute;
            left: 0;
            top: 0;
        }

        /* Stato vuoto */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #555;
            text-align: center;
            min-height: 300px;
        }
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        /* RESPONSIVE */
        @media (max-width: 992px) {
            .skill-layout {
                flex-direction: column;
                align-items: center;
            }
            .info-column {
                width: 100%;
                max-width: 700px;
                position: static; /* Rimuove sticky su mobile */
            }
            .tree-wrapper {
                min-height: 500px;
            }
        }

        @media (max-width: 768px) {
            .skill-node { width: 50px; height: 50px; }
            .skill-node.key-node { width: 65px; height: 65px; }
            .skill-tab { padding: 0.5rem 1rem; flex-grow: 1; }
        }
    </style>
</head>
<body>
</head>
<body>

    <nav class="sidebar" id="sidebar-container"></nav>

    <main class="main-content">
        <header class="hero-mini">
            <div class="hero-title">
                <h1>Maestrie e Poteri</h1>
                <div class="subtitle">L'evoluzione dell'anima</div>
            </div>
        </header>

        <div class="container">
            
            <div class="skill-nav">
                <div class="skill-tab" onclick="switchCharacter('apothecary')">Apothecary</div>
                <div class="skill-tab" onclick="switchCharacter('garun')">Ga'Run</div>
                <div class="skill-tab" onclick="switchCharacter('randra')">Ran'Dra</div>
                <div class="skill-tab active" onclick="switchCharacter('valdor')">Valdor</div>
            </div>

            <div class="skill-layout">
                
                <div class="tree-column">
                    <div class="tree-wrapper" id="tree-container">
                        <svg class="tree-connections" id="tree-lines"></svg>
                        </div>
                </div>

                <div class="info-column">
                    <div class="info-card" id="info-panel">
                        <div class="empty-state">
                            <i class="fas fa-hand-pointer"></i>
                            <p>Caricamento dati...</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script src="../assets/js/layout.js"></script>
    
    <script>
        // === CONFIGURAZIONE ===
        const BASE_PATH = '../assets/img/cripta-di-sangue/skill_trees/';
        const JSON_FILE = '../assets/data/skills.json';
        
        // Contenitore globale per i dati
        let skillsData = {}; 

        const container = document.getElementById('tree-container');
        const svgLines = document.getElementById('tree-lines');
        const infoPanel = document.getElementById('info-panel');

        // === CARICAMENTO DATI ===
        async function loadSkillsData() {
            try {
                const response = await fetch(JSON_FILE);
                
                if (!response.ok) {
                    throw new Error(`Errore HTTP: ${response.status}`);
                }
                
                skillsData = await response.json();
                
                // Carica il primo personaggio di default una volta ottenuti i dati
                switchCharacter('randra');
                resetInfoPanel();

            } catch (error) {
                console.error("Errore nel caricamento del JSON:", error);
                infoPanel.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Impossibile caricare le abilità</h3>
                        <p>Assicurati di usare un server locale (Live Server) e che il file ${JSON_FILE} sia nella cartella.</p>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }

        // === LOGICA ALBERO ===
        function switchCharacter(charKey) {
            // Controlla se i dati sono stati caricati
            if (!skillsData[charKey]) return;

            // Aggiorna tab attivo
            document.querySelectorAll('.skill-tab').forEach(t => {
                t.classList.remove('active');
                if(t.getAttribute('onclick').includes(`'${charKey}'`)) t.classList.add('active');
            });

            // Pulisci
            container.querySelectorAll('.skill-node').forEach(n => n.remove());
            svgLines.innerHTML = '';
            resetInfoPanel();

            const data = skillsData[charKey];

            // Sfondo dinamico
            const bgUrl = resolvePath(data.bgImage);
            
            // Imposta sfumatura in base al personaggio
            let gradientColor = '#000';
            if(charKey === 'valdor' || charKey === 'garun') gradientColor = '#3a0000';
            else if(charKey === 'apothecary') gradientColor = '#4a0000';
            else gradientColor = '#002200';

            container.style.backgroundImage = `url('${bgUrl}'), radial-gradient(circle, ${gradientColor}, #000)`;

            // Disegna Linee
            data.nodes.forEach(node => {
                if (node.connections) {
                    node.connections.forEach(targetId => {
                        const targetNode = data.nodes.find(n => n.id === targetId);
                        if (targetNode) drawLine(node, targetNode);
                    });
                }
            });

            // Disegna Nodi
            data.nodes.forEach(node => {
                const el = document.createElement('div');
                let stateClass;

                switch (node.state) {
                    case 'unlocked': stateClass = 'unlocked'; break;
                    case 'unlockable': stateClass = 'unlockable'; break;
                    default: stateClass = 'locked';
                }
                el.className = `skill-node ${stateClass} ${node.keyNode ? 'key-node' : ''}`;
                
                el.style.left = node.x + '%';
                el.style.top = node.y + '%';
                
                const iconUrl = resolvePath(node.icon);
                el.style.backgroundImage = `url('${iconUrl}')`;

                el.addEventListener('mouseenter', () => updateInfoPanel(node));
                
                container.appendChild(el);
            });
        }

        function resolvePath(path) {
            if (!path) return '';
            // Se è un URL completo o base64, usalo così com'è
            if (path.startsWith('http') || path.startsWith('data:')) {
                return path;
            }
            // Altrimenti aggiungi il percorso base
            return BASE_PATH + path;
        }

        function drawLine(start, end) {
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', start.x + '%');
            line.setAttribute('y1', start.y + '%');
            line.setAttribute('x2', end.x + '%');
            line.setAttribute('y2', end.y + '%');

            const map = {
                unlocked: 'unlocked',
                unlockable: 'unlockable'
            };
            line.setAttribute('class', `connection-line ${map[end.state] ?? ''}`);

            svgLines.appendChild(line);
        }

        function updateInfoPanel(node) {
            const iconUrl = resolvePath(node.icon);
            infoPanel.innerHTML = `
                <div class="info-header">
                    <img src="${iconUrl}" class="info-icon">
                    <h3 class="info-title">${node.title}</h3>
                </div>
                <p class="info-flavor">${node.flavor}</p>
                <div class="info-desc">${node.desc}</div>
            `;
        }

        function resetInfoPanel() {
            infoPanel.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-hand-pointer"></i>
                    <p>Passa il cursore su un nodo<br>per rivelarne i segreti.</p>
                </div>
            `;
        }

        // Avvio al caricamento della pagina
        document.addEventListener('DOMContentLoaded', loadSkillsData);
    </script>
</body>
</html>